matrix:
  fast_finish: true
  allow_failures:
    - rust: nightly
  include:
    # - language: rust
    #   # We use OSX so that we can get a reasonably up to date version of SQLCipher.
    #   # (The version in Travis's default Ubuntu Trusty is much too old).
    #   os: osx
    #   before_install:
    #     - brew install sqlcipher --with-fts
    #   rust: 1.25.0  # Must align with `build/version.rs`.
    #   script:
    #     - ./scripts/cargo_test.sh
    #   after_success:
    #     - |
    #       if [[ "$TRAVIS_PULL_REQUEST" = "false" && "$TRAVIS_BRANCH" == "master" ]]; then
    #         cargo doc &&
    #         echo "<meta http-equiv=refresh content=0;url=mentat/index.html>" > target/doc/index.html &&
    #         git clone https://github.com/davisp/ghp-import.git &&
    #         ./ghp-import/ghp_import.py -n -p -f -r https://"$GH_TOKEN"@github.com/"$TRAVIS_REPO_SLUG.git" target/doc
    #       fi
    #   cache: cargo
    # - language: rust
    #   # We use OSX so that we can get a reasonably up to date version of SQLCipher.
    #   # (The version in Travis's default Ubuntu Trusty is much too old).
    #   os: osx
    #   before_install:
    #     - brew install sqlcipher --with-fts
    #   rust: stable
    #   script:
    #     - ./scripts/cargo_test.sh
    #   cache: cargo
    # - language: rust
    #   # We use OSX so that we can get a reasonably up to date version of SQLCipher.
    #   # (The version in Travis's default Ubuntu Trusty is much too old).
    #   os: osx
    #   before_install:
    #     - brew install sqlcipher --with-fts
    #   rust: beta
    #   script:
    #     - ./scripts/cargo_test.sh
    #   cache: cargo
    # - language: rust
    #   # We use OSX so that we can get a reasonably up to date version of SQLCipher.
    #   # (The version in Travis's default Ubuntu Trusty is much too old).
    #   os: osx
    #   before_install:
    #     - brew install sqlcipher --with-fts
    #   rust: nightly
    #   script:
    #     - ./scripts/cargo_test.sh
    #   cache: cargo
    - language: rust
      dist: trusty
      rust: stable
      os: osx
      install:
        - rustup target add aarch64-apple-ios armv7-apple-ios armv7s-apple-ios x86_64-apple-ios i386-apple-ios
        # Cargo-lipo needs to be Beta version available on master and not crates version to handle building in subdirectories
        - cargo install --git https://github.com/TimNN/cargo-lipo
        - instruments -s devices
      script:
        - >
          cd ffi &&
          cargo lipo --release &&
          cd ..
        - cd sdks/swift/Mentat
        - xcodebuild -configuration Debug -scheme "Mentat Debug" -sdk iphonesimulator test -destination 'platform=iOS Simulator,name=iPhone X,OS=11.4'
        - cd ../../..
